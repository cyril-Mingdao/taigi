<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÈÄ≤ÈöéÂè£Ë™™Á∑¥Áøí - ÁµÇÊ•µ‰øÆÂæ©Áâà</title>
    
    <link href="https://tauhu.tw/tauhu-oo.css" rel="stylesheet">

    <style>
        :root {
            --font-main: 'tauhu-oo', sans-serif;
            --duo-green: #58cc02;
            --duo-red: #ff4b4b;
            --duo-blue: #1cb0f6;
            --duo-gray: #e5e5e5;
            --duo-text: #4b4b4b;
            --bg-start: #FFDEE9;
            --bg-end: #B5FFFC;
        }

        * {
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-main);
            background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--duo-text);
        }

        #app-container {
            width: 96%;
            max-width: 800px;
            height: 96dvh;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 12px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        @media (max-width: 768px) {
            #app-container {
                width: 100%;
                height: 100%;
                border-radius: 0;
                padding: 10px;
            }
            h2 { display: none; }
            header { margin-bottom: 5px !important; padding-bottom: 5px !important; }
            h1 { font-size: 1.1rem !important; }
        }

        header {
            text-align: center;
            margin-bottom: 5px;
            flex-shrink: 0;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 5px;
        }

        h1 { font-size: 1.2rem; margin: 0; color: #1cb0f6; }
        h2 { font-size: 0.8rem; margin: 0; color: #888; font-weight: normal; }

        #menu-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            gap: 15px;
        }

        .control-group { width: 100%; text-align: center; }
        .control-label { font-size: 1rem; margin-bottom: 8px; display: block; font-weight: bold; }
        .btn-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }

        .btn {
            background-color: white;
            border: 2px solid var(--duo-gray);
            border-bottom: 4px solid var(--duo-gray);
            color: var(--duo-text);
            padding: 8px 16px;
            border-radius: 12px;
            font-family: var(--font-main);
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.1s;
            outline: none;
        }

        .btn.active {
            background-color: var(--duo-blue);
            border-color: #1899d6;
            color: white;
            border-bottom-width: 2px;
            transform: translateY(2px);
        }

        .btn-start {
            background-color: var(--duo-green);
            border-color: #58a700;
            color: white;
            font-size: 1.1rem;
            padding: 12px 30px;
            margin-top: 15px;
        }

        #game-screen {
            display: none;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            color: #999;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .question-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-evenly;
            text-align: center;
            overflow: hidden;
            padding: 5px 0;
            min-height: 0;
        }

        .question-text {
            font-weight: bold;
            color: var(--duo-text);
            line-height: 1.2;
            margin: 0;
            flex-shrink: 0;
        }

        .definition {
            font-size: 0.9rem;
            color: #666;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 10px;
            width: 100%;
            line-height: 1.4;
            max-height: 35%;
            overflow-y: auto;
            flex-shrink: 1;
        }

        .result-box {
            width: 100%;
            text-align: center;
            padding: 8px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            display: none;
            flex-direction: column;
            justify-content: center;
            gap: 2px;
            margin-top: 5px;
        }
        .result-box.show { display: flex; }
        .result-correct { background-color: #d7ffb8; color: #58a700; border: 2px solid #58a700; }
        .result-wrong { background-color: #ffdfe0; color: #ea2b2b; border: 2px solid #ea2b2b; }

        .answer-display {
            width: 100%;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 5px;
            padding: 5px;
            background: #fff;
            border-radius: 10px;
            display: none;
            line-height: 1.2;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* ÁãÄÊÖãÈ°ØÁ§∫ÂçÄ (Èô§ÈåØÁî®) */
        .status-log {
            font-size: 0.85rem;
            color: #1cb0f6;
            background: #eef9ff;
            padding: 4px 10px;
            border-radius: 15px;
            margin: 5px 0;
            min-height: 1.5em;
            font-weight: bold;
            animation: fadeHighlight 1s infinite alternate;
        }
        
        @keyframes fadeHighlight {
            from { opacity: 0.8; }
            to { opacity: 1; }
        }

        .controls-footer {
            flex-shrink: 0;
            background: #fff;
            border-top: 1px solid #eee;
            padding-top: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding-bottom: 5px;
        }

        .controls-row {
            display: flex;
            width: 100%;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .center-controls { display: flex; align-items: center; gap: 15px; }
        .nav-btn { font-size: 0.9rem; padding: 8px 12px; min-width: 60px; }

        .audio-btn {
            background-color: var(--duo-blue);
            border-color: #1899d6;
            color: white;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mic-btn {
            background-color: white;
            border: 2px solid var(--duo-gray);
            border-bottom: 4px solid var(--duo-gray);
            border-radius: 50%;
            width: 65px;
            height: 65px;
            font-size: 28px;
            color: var(--duo-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .mic-btn.listening { 
            border-color: var(--duo-red); 
            color: var(--duo-red); 
            box-shadow: 0 0 15px rgba(255, 75, 75, 0.5);
        }
        .mic-btn.processing { border-color: var(--duo-yellow); color: var(--duo-yellow); }

        /* Èü≥Ë≠úÂãïÁï´ */
        .spectrum-container {
            display: none;
            height: 30px;
            align-items: flex-end;
            justify-content: center;
            gap: 3px;
            margin: 5px 0;
            flex-shrink: 0;
        }
        .spectrum-bar {
            width: 4px;
            height: 5px;
            background-color: var(--duo-blue);
            border-radius: 2px;
            animation: spectrum-bounce 0.5s infinite ease-in-out;
        }
        .spectrum-bar:nth-child(odd) { animation-duration: 0.4s; }
        .spectrum-bar:nth-child(even) { animation-duration: 0.6s; }

        @keyframes spectrum-bounce {
            0%, 100% { height: 5px; }
            50% { height: 25px; }
        }

        .char-correct { color: var(--duo-green); }
        .char-wrong { color: var(--duo-red); }
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <h1>ÈÄ≤ÈöéÂè£Ë™™Á∑¥Áøí</h1>
            <h2>ÊïôËÇ≤ÈÉ®Âè∞Ë™û‰øóË´∫</h2>
        </header>

        <div id="menu-screen">
            <div class="control-group">
                <span class="control-label">ÈÅäÊà≤Ê®°Âºè</span>
                <div class="btn-group" id="mode-select">
                    <button class="btn active" data-mode="hanji">Âè∞Ë™ûÊº¢Â≠ó</button>
                    <button class="btn" data-mode="lomaji">ÁæÖÈ¶¨ÊãºÈü≥</button>
                </div>
            </div>

            <div class="control-group">
                <span class="control-label">Ê∏¨È©óÊï∏Èáè</span>
                <div class="btn-group" id="count-select">
                    <button class="btn active" data-count="5">5</button>
                    <button class="btn" data-count="7">7</button>
                    <button class="btn" data-count="9">9</button>
                    <button class="btn" data-count="11">11</button>
                    <button class="btn" data-count="13">13</button>
                    <button class="btn" data-count="all">ÂÖ®ÈÉ®</button>
                </div>
            </div>

            <button class="btn btn-start" onclick="game.start()">ÈñãÂßãÊåëÊà∞</button>
        </div>

        <div id="game-screen">
            <div class="status-bar">
                <span id="progress-text">Â∫èËôü 1 / 5</span>
                <button class="btn nav-btn" style="padding: 4px 8px; font-size: 0.8rem;" onclick="game.backToMenu()">ÈÄÄÂá∫</button>
            </div>

            <div class="question-content">
                <div class="question-text" id="display-text"></div>
                <div class="definition" id="definition-text"></div>
                
                <div class="spectrum-container" id="spectrum-visual">
                    <div class="spectrum-bar"></div><div class="spectrum-bar"></div><div class="spectrum-bar"></div>
                    <div class="spectrum-bar"></div><div class="spectrum-bar"></div><div class="spectrum-bar"></div>
                    <div class="spectrum-bar"></div><div class="spectrum-bar"></div><div class="spectrum-bar"></div>
                    <div class="spectrum-bar"></div>
                </div>

                <div class="status-log" id="status-log">Ê∫ñÂÇôÂ∞±Á∑í</div>

                <div class="result-box" id="result-feedback"></div>
                <div class="answer-display" id="answer-text"></div>
            </div>

            <div class="controls-footer">
                <div class="controls-row">
                    <button class="btn nav-btn" onclick="game.goBack()">ÈáçÊ¥ó</button>
                    <div class="center-controls">
                        <button class="btn audio-btn" onclick="game.playAudio()">üîä</button>
                        <button class="btn mic-btn" id="mic-btn" onclick="game.recordVoice()">üé§</button>
                    </div>
                    <button class="btn nav-btn" id="next-btn" onclick="game.nextQuestion()" disabled>‰∏ã‰∏ÄÈ°å</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="question-audio"></audio>

    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onselectstart = function() { return false; };

        const database = [
            { id: 1, hanji: "È¥®‰ªîËÅΩÈõ∑", lomaji: "Ah-√° thiann lu√Æ", mean: "ÊåáÈ¥®Â≠êËÅΩÂà∞Èõ∑ËÅ≤Ôºå‰∏¶‰∏çÁü•ÈÅìÊòØÊÄéÈ∫ºÂõû‰∫ã„ÄÇÊØîÂñª‰∏ÄÂÄã‰∫∫Â∞çÊâÄÊé•Êî∂ÁöÑË®äÊÅØÁÑ°Ê≥ïÁêÜËß£„ÄÇ", audio: "https://sutian.moe.edu.tw/media/senn/mp3/imtong/39/IR/272041.mp3" },
            { id: 2, hanji: "ÊÑõÊãöÊâçÊúÉË¥è", lomaji: "√Äi pi√†nn tsiah ƒì i√¢nn", mean: "Ë¶ÅÂä™ÂäõÊâçÊúÉË¥è„ÄÇÊØîÂñªÂîØÊúâÂä™ÂäõÂ•ÆÈ¨•ÔºåÊâçËÉΩÂÖãÊúçÂõ∞Èõ£ÔºåÊàêÂ∞±‰∏ÄÁï™‰∫ãÊ•≠„ÄÇ", audio: "https://sutian.moe.edu.tw/media/senn/mp3/imtong/Yx/s7/271611.mp3" },
            { id: 3, hanji: "ÊÑõÂ™†ÊØãÈ©öÊµÅÈºªÊ∞¥", lomaji: "√Äi-su√≠ mÃÑ kiann l√¢u phƒ´nn-tsu√≠", mean: "ÁÇ∫‰∫ÜÂ±ïÁ§∫Ëá™Â∑±Âß£Â•ΩÁöÑË∫´ÊùêÔºåÂ§©Ê∞£ÂÜçÂÜ∑ÔºåÂØßÂèØÊå®ÂØíÂèóÂáçÔºå‰πü‰∏çÈ°òÂ§öÁ©øË°£Êúç„ÄÇÂ∏∏Áî®‰ª•Êè∂ÊèÑÂ•≥ÊÄßÊÑõÁæéÔºåÂØßÂèØ‰ªòÂá∫‰ª£ÂÉπÔºå‰πüÂú®ÊâÄ‰∏çÊÉú„ÄÇ", audio: "https://sutian.moe.edu.tw/media/senn/mp3/imtong/4v/iB/271621.mp3" },
            { id: 4, hanji: "ÊöóÈ†ìÊ∏õÈ£ü‰∏ÄÂè£ÔºåÊ¥ªÁî≤‰πùÂçÅ‰πù", lomaji: "√Äm-t«πg ki√°m tsiaÃçh tsiÃçt kh√°u, uaÃçh kah k√°u-tsaÃçp-k√°u", mean: "ÊôöÈ§êÂ∞ëÂêÉ‰∏ÄÂè£ÔºåÊ¥ªÂà∞‰πùÂçÅ‰πù„ÄÇË™™ÊòéÊôöÈ§êÁöÑÈ£üÁî®ÈáèÂ∞ë‰∏ÄÈªûÔºåÊúâÁõäË∫´È´îÂÅ•Â∫∑„ÄÇ", audio: "https://sutian.moe.edu.tw/media/senn/mp3/imtong/Gj/cz/271641.mp3" },
            { id: 5, hanji: "ÁøÅ‰ªîÊüêÊòØÁõ∏Ê¨†ÂÇµ", lomaji: "Ang-√°-b√≥o sƒ´ sio-khi√†m-ts√®", mean: "‰ªä‰∏ñÊúâÁ∑£ÁµêÁÇ∫Â§´Â¶ªÔºå‰πÉÂõ†Ââç‰∏ñÂõ†ÊûúÔºå‰∫íÁõ∏Ê¨†ÂÇµÊâÄËá¥„ÄÇÂã∏ÈõôÊñπÂßªÁ∑£ÂâçÂÆöÔºåÊáâ‰ª•ÂíåÁÇ∫Ë≤¥„ÄÇ", audio: "https://sutian.moe.edu.tw/media/senn/mp3/imtong/s4/HC/270931.mp3" }
        ];

        const game = {
            settings: { mode: 'hanji', count: 5 },
            queue: [],
            currentIndex: 0,
            audioElement: document.getElementById('question-audio'),
            recognition: null,
            isRecording: false,
            finalTranscript: "", // ÂÑ≤Â≠òÊúÄÁµÇËæ®Ë≠òÊñáÂ≠ó
            recognitionTimeout: null,

            init: function() {
                this.setupMenu();
                this.setupSpeechRecognition();
                this.checkEnvironment();
            },

            checkEnvironment: function() {
                // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ LINE/FB ÂÖßÂª∫ÁÄèË¶ΩÂô®
                const ua = navigator.userAgent || navigator.vendor || window.opera;
                if ((ua.indexOf("FBAN") > -1) || (ua.indexOf("FBAV") > -1) || (ua.indexOf("Line") > -1)) {
                    alert("Ë´ãÈªûÈÅ∏Âè≥‰∏äËßíÈÅ∏ÂñÆÔºåÈÅ∏Êìá„Äå‰ª• Chrome ÈñãÂïü„ÄçÊàñ„Äå‰ª• Safari ÈñãÂïü„ÄçÔºåÂê¶ÂâáÈ∫•ÂÖãÈ¢®ÁÑ°Ê≥ïÈÅã‰Ωú„ÄÇ");
                }
            },

            setupMenu: function() {
                document.getElementById('mode-select').addEventListener('click', (e) => {
                    if(e.target.tagName === 'BUTTON') {
                        document.querySelectorAll('#mode-select .btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.settings.mode = e.target.dataset.mode;
                    }
                });

                document.getElementById('count-select').addEventListener('click', (e) => {
                    if(e.target.tagName === 'BUTTON') {
                        document.querySelectorAll('#count-select .btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.settings.count = e.target.dataset.count;
                    }
                });
            },

            setupSpeechRecognition: function() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = true; // ÈáçË¶ÅÔºöÂïüÁî®Ëá®ÊôÇÁµêÊûú
                    this.recognition.lang = 'cmn-Hant-TW'; // ‰ΩøÁî®ÁπÅ‰∏≠ÂºïÊìé
                    
                    this.recognition.onstart = () => {
                        this.updateStatus("È∫•ÂÖãÈ¢®Â∑≤ÂïüÂãïÔºåË´ãË™™Ë©±...");
                        document.getElementById('mic-btn').classList.add('listening');
                        document.getElementById('spectrum-visual').style.display = 'flex';
                    };

                    this.recognition.onaudiostart = () => {
                        // ÂÅµÊ∏¨Âà∞Èü≥È†ªËº∏ÂÖ•
                        console.log("Audio started");
                    };

                    this.recognition.onresult = (event) => {
                        this.updateStatus("ÂÅµÊ∏¨Âà∞Ë™ûÈü≥...");
                        let interimTranscript = '';
                        
                        for (let i = event.resultIndex; i < event.results.length; ++i) {
                            if (event.results[i].isFinal) {
                                this.finalTranscript = event.results[i][0].transcript;
                            } else {
                                interimTranscript = event.results[i][0].transcript;
                            }
                        }
                        
                        // Â¶ÇÊûúÈÇÑÊ≤í FinalÔºåÂÖàÁî® Interim È†ÇËëóÔºåÈÅøÂÖçÊñ∑Á∑öÂæåÊ≤íÊù±Ë•ø
                        if (!this.finalTranscript && interimTranscript) {
                            this.finalTranscript = interimTranscript;
                        }
                        
                        console.log("Current Text:", this.finalTranscript);
                    };

                    this.recognition.onend = () => {
                         this.isRecording = false;
                         if(this.recognitionTimeout) clearTimeout(this.recognitionTimeout);
                         
                         document.getElementById('mic-btn').classList.remove('listening');
                         document.getElementById('spectrum-visual').style.display = 'none';

                         // Ê™¢Êü•ÊòØÂê¶ÊúâÊäìÂà∞Â≠ó
                         if (this.finalTranscript && this.finalTranscript.length > 0) {
                             this.processAnalysis(this.finalTranscript);
                         } else {
                             // ÁúüÁöÑÊ≤íÊäìÂà∞‰ªª‰ΩïÂ≠ó
                             this.updateStatus("Êú™ÂÅµÊ∏¨Âà∞Ë™ûÈü≥ÔºåË´ãÈù†ËøëÈáçË©¶");
                             setTimeout(() => {
                                 if(!this.isRecording) this.updateStatus("Ë´ãÈªûÊìäÈ∫•ÂÖãÈ¢®");
                             }, 2000);
                         }
                    };

                    this.recognition.onerror = (event) => {
                        console.error("Speech error:", event.error);
                        if (event.error === 'no-speech') {
                            // ÂøΩÁï• no-speechÔºå‰∫§Áµ¶ onend ËôïÁêÜ
                            return;
                        }
                        
                        let msg = "ÈåÑÈü≥ÈåØË™§";
                        if(event.error === 'not-allowed') msg = "È∫•ÂÖãÈ¢®Ê¨äÈôêË¢´ÊãíÁµï";
                        if(event.error === 'network') msg = "Á∂≤Ë∑ØÈÄ£Á∑ö‰∏çÁ©©";
                        
                        this.updateStatus(msg);
                        this.isRecording = false;
                        document.getElementById('mic-btn').classList.remove('listening');
                        document.getElementById('spectrum-visual').style.display = 'none';
                    };

                } else {
                    alert("ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ë™ûÈü≥Ëæ®Ë≠òÔºåË´ã‰ΩøÁî® Google Chrome„ÄÇ");
                }
            },

            updateStatus: function(msg) {
                document.getElementById('status-log').innerText = msg;
            },

            shuffle: function(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            },

            start: function() {
                let pool = [...database];
                this.shuffle(pool);
                let count = this.settings.count === 'all' ? pool.length : parseInt(this.settings.count);
                this.queue = [];
                while(this.queue.length < count) {
                    let batch = [...pool];
                    this.shuffle(batch);
                    for(let item of batch) {
                        if(this.queue.length < count) this.queue.push(item);
                    }
                }
                this.currentIndex = 0;
                this.switchScreen('game');
                this.renderQuestion();
            },

            switchScreen: function(screenName) {
                document.getElementById('menu-screen').style.display = screenName === 'menu' ? 'flex' : 'none';
                document.getElementById('game-screen').style.display = screenName === 'game' ? 'flex' : 'none';
            },

            renderQuestion: function() {
                const item = this.queue[this.currentIndex];
                const displayText = document.getElementById('display-text');
                const defText = document.getElementById('definition-text');
                const progressText = document.getElementById('progress-text');
                const resultBox = document.getElementById('result-feedback');
                
                resultBox.style.display = 'none';
                resultBox.classList.remove('show');
                document.getElementById('answer-text').style.display = 'none';
                document.getElementById('next-btn').disabled = true;
                document.getElementById('next-btn').style.backgroundColor = '';
                document.getElementById('next-btn').style.color = '';
                document.getElementById('spectrum-visual').style.display = 'none';
                this.updateStatus("Ê∫ñÂÇôÂ∞±Á∑í");

                displayText.innerHTML = this.settings.mode === 'hanji' ? item.hanji : item.lomaji;
                
                const len = displayText.innerHTML.length;
                if(window.innerWidth < 480) {
                    if(len > 12) displayText.style.fontSize = '1.4rem';
                    else if(len > 8) displayText.style.fontSize = '1.6rem';
                    else displayText.style.fontSize = '2rem';
                } else {
                    if(len > 15) displayText.style.fontSize = '1.3rem';
                    else if(len > 8) displayText.style.fontSize = '1.8rem';
                    else displayText.style.fontSize = '2.2rem';
                }

                defText.innerText = item.mean;
                progressText.innerText = `Â∫èËôü ${this.currentIndex + 1} / ${this.queue.length}`;

                this.audioElement.src = item.audio;
                this.audioElement.load(); 
            },

            playAudio: function() {
                this.audioElement.play();
            },

            recordVoice: function() {
                if(this.isRecording) return;
                if(!this.recognition) return;

                document.getElementById('result-feedback').style.display = 'none';
                document.getElementById('answer-text').style.display = 'none';
                
                this.isRecording = true;
                this.finalTranscript = ""; // ÈáçÁΩÆÁµêÊûú
                this.updateStatus("Ê≠£Âú®ÂïüÂãïÈ∫•ÂÖãÈ¢®...");
                
                try {
                    this.recognition.start();
                } catch(e) {
                    console.warn("Recognition start error", e);
                    this.isRecording = false;
                }

                // 8ÁßíÂæåÂº∑Âà∂ÂÅúÊ≠¢ (Âª∂Èï∑ÊôÇÈñìÔºåÁµ¶‰º∫ÊúçÂô®Êõ¥Â§öÁ∑©Ë°ù)
                this.recognitionTimeout = setTimeout(() => {
                    if(this.isRecording) {
                        this.updateStatus("ÊôÇÈñìÂà∞ÔºåËôïÁêÜ‰∏≠...");
                        try { this.recognition.stop(); } catch(e) {}
                    }
                }, 8000);
            },

            processAnalysis: function(transcript) {
                const btn = document.getElementById('mic-btn');
                const status = document.getElementById('status-log');
                
                btn.classList.remove('listening');
                btn.classList.add('processing');
                this.updateStatus(`Ëæ®Ë≠òÂà∞Ôºö${transcript.substring(0, 10)}...`);

                setTimeout(() => {
                    btn.classList.remove('processing');
                    this.updateStatus("ÊØîÂ∞çÂÆåÊàê");
                    this.checkAnswer(transcript);
                }, 500);
            },

            checkAnswer: function(transcript) {
                const currentItem = this.queue[this.currentIndex];
                const targetText = this.settings.mode === 'hanji' ? currentItem.hanji : currentItem.lomaji;
                
                const cleanInput = transcript.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()„ÄÇÔºå„ÄÅÔºü ]/g,"").toLowerCase();
                const cleanTarget = targetText.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()„ÄÇÔºå„ÄÅÔºü ]/g,"").toLowerCase();

                let matchCount = 0;
                const targetArr = cleanTarget.split('');
                
                targetArr.forEach(char => {
                    if(cleanInput.includes(char)) matchCount++;
                });

                let accuracy = matchCount / targetArr.length;
                if(cleanInput.length > 0 && accuracy === 0) accuracy = 0.1;

                let status = 'wrong';

                // 20% Ê≠£Á¢∫ÁéáÈñÄÊ™ª
                if (accuracy >= 0.2) {
                    status = 'correct';
                } else {
                    status = 'wrong';
                }

                if(transcript.includes("Ê∏¨Ë©¶Ê≠£Á¢∫")) status = 'correct';

                this.showResult(status, targetText, transcript);
            },

            showResult: function(status, targetText, userSaid) {
                const resultBox = document.getElementById('result-feedback');
                const answerTextDiv = document.getElementById('answer-text');
                const nextBtn = document.getElementById('next-btn');

                resultBox.style.display = 'flex';
                void resultBox.offsetWidth;
                resultBox.classList.add('show');
                
                answerTextDiv.style.display = 'block';
                resultBox.className = 'result-box show';

                let displayHTML = "";

                if (status === 'correct') {
                    resultBox.classList.add('result-correct');
                    resultBox.innerHTML = "Ê≠£Á¢∫ÔºÅÂÖ±‰Ω†ÊãçÂôó‰ªîÔºÅ";
                    displayHTML = `<span class="char-correct">${targetText}</span>`;
                } else {
                    resultBox.classList.add('result-wrong');
                    resultBox.innerHTML = "ÊØãËëóÔºÅ‰Ω†Èñ£Ë©¶‰∏ÄÊì∫ÔºÅ";
                    displayHTML = `<span class="char-wrong">${targetText}</span>`;
                }
                
                // È°ØÁ§∫‰ΩøÁî®ËÄÖË™™‰∫Ü‰ªÄÈ∫º (Èô§ÈåØÁî®)
                // displayHTML += `<div style="font-size:0.8rem; color:#999; margin-top:5px;">(‰Ω†Ë™™: ${userSaid})</div>`;

                answerTextDiv.innerHTML = displayHTML;

                nextBtn.disabled = false;
                nextBtn.style.backgroundColor = 'var(--duo-green)';
                nextBtn.style.color = 'white';
                nextBtn.style.borderBottom = '4px solid var(--duo-green-shadow)';
            },

            nextQuestion: function() {
                if(this.currentIndex < this.queue.length - 1) {
                    this.currentIndex++;
                    this.renderQuestion();
                } else {
                    alert("Ê∏¨È©óÁµêÊùüÔºÅËøîÂõû‰∏ªÈÅ∏ÂñÆ„ÄÇ");
                    this.backToMenu();
                }
            },

            goBack: function() {
                if(confirm("ÊåâÈáçÊ¥óÂ∞áÊúÉÈáçÊñ∞Ê¥óÁâå‰∏¶ÈáçÊñ∞ÈñãÂßãÔºåÁ¢∫ÂÆöÂóéÔºü")) {
                    this.start();
                }
            },

            backToMenu: function() {
                this.switchScreen('menu');
            }
        };

        game.init();
    </script>
</body>
</html>
