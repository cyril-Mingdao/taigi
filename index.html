<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é€²éšå£èªªç·´ç¿’ - æ•™è‚²éƒ¨å°èªä¿—è«º</title>
    
    <link href="https://tauhu.tw/tauhu-oo.css" rel="stylesheet">

    <style>
        :root {
            --font-main: 'tauhu-oo', sans-serif;
            --duo-green: #58cc02;
            --duo-green-shadow: #58a700;
            --duo-red: #ff4b4b;
            --duo-red-shadow: #ea2b2b;
            --duo-blue: #1cb0f6;
            --duo-blue-shadow: #1899d6;
            --duo-yellow: #ffc800;
            --duo-yellow-shadow: #e5b400;
            --duo-gray: #e5e5e5;
            --duo-text: #4b4b4b;
            --bg-start: #FFDEE9;
            --bg-end: #B5FFFC;
        }

        * {
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-main);
            background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--duo-text);
        }

        #app-container {
            width: 96%;
            max-width: 800px;
            height: 96vh;
            height: 96dvh;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 12px;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.3s ease;
        }

        @media (max-width: 768px) {
            #app-container {
                width: 100%;
                height: 100%;
                border-radius: 0;
                padding: 10px;
                box-shadow: none;
            }
            h2 { display: none; }
            header { margin-bottom: 5px !important; padding-bottom: 5px !important; }
            h1 { font-size: 1.1rem !important; }
        }

        header {
            text-align: center;
            margin-bottom: 5px;
            flex-shrink: 0;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 5px;
        }

        h1 { font-size: 1.2rem; margin: 0; color: var(--duo-blue-shadow); }
        h2 { font-size: 0.8rem; margin: 0; color: #888; font-weight: normal; }

        #menu-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            gap: 15px;
        }

        .control-group { width: 100%; text-align: center; }
        .control-label { font-size: 1rem; margin-bottom: 8px; display: block; font-weight: bold; }
        .btn-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }

        .btn {
            background-color: white;
            border: 2px solid var(--duo-gray);
            border-bottom: 4px solid var(--duo-gray);
            color: var(--duo-text);
            padding: 8px 16px;
            border-radius: 12px;
            font-family: var(--font-main);
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.1s;
            outline: none;
        }

        .btn:active, .btn.active {
            background-color: var(--duo-blue);
            border-color: var(--duo-blue-shadow);
            color: white;
            border-bottom-width: 2px;
            transform: translateY(2px);
        }

        .btn-start {
            background-color: var(--duo-green);
            border-color: var(--duo-green-shadow);
            color: white;
            font-size: 1.1rem;
            padding: 12px 30px;
            margin-top: 15px;
        }

        #game-screen {
            display: none;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            color: #999;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .question-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-evenly;
            text-align: center;
            overflow: hidden;
            padding: 5px 0;
            min-height: 0;
        }

        .question-text {
            font-weight: bold;
            color: var(--duo-text);
            line-height: 1.2;
            margin: 0;
            flex-shrink: 0;
        }

        .definition {
            font-size: 0.9rem;
            color: #666;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 10px;
            width: 100%;
            line-height: 1.4;
            max-height: 35%;
            overflow-y: auto;
            flex-shrink: 1;
        }
        .definition::-webkit-scrollbar { display: none; }

        .result-box {
            width: 100%;
            text-align: center;
            padding: 8px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            display: none;
            flex-direction: column;
            justify-content: center;
            gap: 2px;
            opacity: 0;
            transition: opacity 0.3s;
            flex-shrink: 0;
            margin-top: 5px;
        }
        .result-box.show { display: flex; }
        .result-correct { background-color: #d7ffb8; color: #58a700; border: 2px solid #58a700; }
        .result-wrong { background-color: #ffdfe0; color: #ea2b2b; border: 2px solid #ea2b2b; }
        .result-partial { background-color: #fff4cc; color: #dcb208; border: 2px solid #dcb208; }

        .answer-display {
            width: 100%;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 5px;
            padding: 5px;
            background: #fff;
            border-radius: 10px;
            display: none;
            line-height: 1.2;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .controls-footer {
            flex-shrink: 0;
            background: #fff;
            border-top: 1px solid #eee;
            padding-top: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding-bottom: 5px;
        }

        .mic-status-text { font-size: 0.75rem; color: #999; height: 1em; }

        .controls-row {
            display: flex;
            width: 100%;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .center-controls { display: flex; align-items: center; gap: 15px; }
        .nav-btn { font-size: 0.9rem; padding: 8px 12px; min-width: 60px; }

        .audio-btn {
            background-color: var(--duo-blue);
            border-color: var(--duo-blue-shadow);
            color: white;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mic-btn {
            background-color: white;
            border: 2px solid var(--duo-gray);
            border-bottom: 4px solid var(--duo-gray);
            border-radius: 50%;
            width: 65px;
            height: 65px;
            font-size: 28px;
            color: var(--duo-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .mic-btn.listening { border-color: var(--duo-red); color: var(--duo-red); animation: pulse 1.5s infinite; }
        .mic-btn.processing { border-color: var(--duo-yellow); color: var(--duo-yellow); animation: spin 1s infinite linear; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 75, 75, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 75, 75, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 75, 75, 0); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); border-bottom-color: var(--duo-yellow-shadow); }
            100% { transform: rotate(360deg); border-bottom-color: var(--duo-yellow-shadow); }
        }

        /* CSS æ¨¡æ“¬éŸ³è­œ */
        .spectrum-container {
            display: none;
            height: 30px;
            align-items: flex-end;
            justify-content: center;
            gap: 3px;
            margin: 5px 0;
            flex-shrink: 0;
        }
        .spectrum-bar {
            width: 4px;
            height: 5px;
            background-color: var(--duo-blue);
            border-radius: 2px;
            animation: spectrum-bounce 0.5s infinite ease-in-out;
        }
        .spectrum-bar:nth-child(odd) { animation-duration: 0.4s; }
        .spectrum-bar:nth-child(even) { animation-duration: 0.6s; }

        @keyframes spectrum-bounce {
            0%, 100% { height: 5px; }
            50% { height: 25px; }
        }

        /* é—œéµå­—å…ƒé¡è‰² */
        .char-correct { color: var(--duo-green); }
        .char-wrong { color: var(--duo-red); }
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <h1>é€²éšå£èªªç·´ç¿’</h1>
            <h2>æ•™è‚²éƒ¨å°èªä¿—è«º</h2>
        </header>

        <div id="menu-screen">
            <div class="control-group">
                <span class="control-label">éŠæˆ²æ¨¡å¼</span>
                <div class="btn-group" id="mode-select">
                    <button class="btn active" data-mode="hanji">å°èªæ¼¢å­—</button>
                    <button class="btn" data-mode="lomaji">ç¾…é¦¬æ‹¼éŸ³</button>
                </div>
            </div>

            <div class="control-group">
                <span class="control-label">æ¸¬é©—æ•¸é‡</span>
                <div class="btn-group" id="count-select">
                    <button class="btn active" data-count="5">5</button>
                    <button class="btn" data-count="7">7</button>
                    <button class="btn" data-count="9">9</button>
                    <button class="btn" data-count="11">11</button>
                    <button class="btn" data-count="13">13</button>
                    <button class="btn" data-count="all">å…¨éƒ¨</button>
                </div>
            </div>

            <button class="btn btn-start" onclick="game.start()">é–‹å§‹æŒ‘æˆ°</button>
        </div>

        <div id="game-screen">
            <div class="status-bar">
                <span id="progress-text">åºè™Ÿ 1 / 5</span>
                <button class="btn nav-btn" style="padding: 4px 8px; font-size: 0.8rem;" onclick="game.backToMenu()">é€€å‡º</button>
            </div>

            <div class="question-content">
                <div class="question-text" id="display-text"></div>
                <div class="definition" id="definition-text"></div>
                
                <div class="spectrum-container" id="spectrum-visual">
                    <div class="spectrum-bar"></div><div class="spectrum-bar"></div><div class="spectrum-bar"></div>
                    <div class="spectrum-bar"></div><div class="spectrum-bar"></div><div class="spectrum-bar"></div>
                    <div class="spectrum-bar"></div><div class="spectrum-bar"></div><div class="spectrum-bar"></div>
                    <div class="spectrum-bar"></div>
                </div>

                <div class="result-box" id="result-feedback"></div>
                <div class="answer-display" id="answer-text"></div>
            </div>

            <div class="controls-footer">
                <div class="mic-status-text" id="mic-status">é»æ“ŠéŒ„éŸ³ (5ç§’)</div>
                
                <div class="controls-row">
                    <button class="btn nav-btn" onclick="game.goBack()">é‡æ´—</button>
                    
                    <div class="center-controls">
                        <button class="btn audio-btn" onclick="game.playAudio()">ğŸ”Š</button>
                        <button class="btn mic-btn" id="mic-btn" onclick="game.recordVoice()">ğŸ¤</button>
                    </div>
                    
                    <button class="btn nav-btn" id="next-btn" onclick="game.nextQuestion()" disabled>ä¸‹ä¸€é¡Œ</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="question-audio"></audio>

    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onselectstart = function() { return false; };

        const database = [
            { id: 1, hanji: "é´¨ä»”è½é›·", lomaji: "Ah-Ã¡ thiann luÃ®", mean: "æŒ‡é´¨å­è½åˆ°é›·è²ï¼Œä¸¦ä¸çŸ¥é“æ˜¯æ€éº¼å›äº‹ã€‚æ¯”å–»ä¸€å€‹äººå°æ‰€æ¥æ”¶çš„è¨Šæ¯ç„¡æ³•ç†è§£ã€‚", audio: "https://sutian.moe.edu.tw/media/senn/mp3/imtong/39/IR/272041.mp3" },
            { id: 2, hanji: "æ„›æ‹šæ‰æœƒè´", lomaji: "Ã€i piÃ nn tsiah Ä“ iÃ¢nn", mean: "è¦åŠªåŠ›æ‰æœƒè´ã€‚æ¯”å–»å”¯æœ‰åŠªåŠ›å¥®é¬¥ï¼Œæ‰èƒ½å…‹æœå›°é›£ï¼Œæˆå°±ä¸€ç•ªäº‹æ¥­ã€‚", audio: "https://sutian.moe.edu.tw/media/senn/mp3/imtong/Yx/s7/271611.mp3" },
            { id: 3, hanji: "æ„›åª æ¯‹é©šæµé¼»æ°´", lomaji: "Ã€i-suÃ­ mÌ„ kiann lÃ¢u phÄ«nn-tsuÃ­", mean: "ç‚ºäº†å±•ç¤ºè‡ªå·±å§£å¥½çš„èº«æï¼Œå¤©æ°£å†å†·ï¼Œå¯§å¯æŒ¨å¯’å—å‡ï¼Œä¹Ÿä¸é¡˜å¤šç©¿è¡£æœã€‚å¸¸ç”¨ä»¥æ¶æ„å¥³æ€§æ„›ç¾ï¼Œå¯§å¯ä»˜å‡ºä»£åƒ¹ï¼Œä¹Ÿåœ¨æ‰€ä¸æƒœã€‚", audio: "https://sutian.moe.edu.tw/media/senn/mp3/imtong/4v/iB/271621.mp3" },
            { id: 4, hanji: "æš—é “æ¸›é£Ÿä¸€å£ï¼Œæ´»ç”²ä¹åä¹", lomaji: "Ã€m-tÇ¹g kiÃ¡m tsiaÌh tsiÌt khÃ¡u, uaÌh kah kÃ¡u-tsaÌp-kÃ¡u", mean: "æ™šé¤å°‘åƒä¸€å£ï¼Œæ´»åˆ°ä¹åä¹ã€‚èªªæ˜æ™šé¤çš„é£Ÿç”¨é‡å°‘ä¸€é»ï¼Œæœ‰ç›Šèº«é«”å¥åº·ã€‚", audio: "https://sutian.moe.edu.tw/media/senn/mp3/imtong/Gj/cz/271641.mp3" },
            { id: 5, hanji: "ç¿ä»”æŸæ˜¯ç›¸æ¬ å‚µ", lomaji: "Ang-Ã¡-bÃ³o sÄ« sio-khiÃ m-tsÃ¨", mean: "ä»Šä¸–æœ‰ç·£çµç‚ºå¤«å¦»ï¼Œä¹ƒå› å‰ä¸–å› æœï¼Œäº’ç›¸æ¬ å‚µæ‰€è‡´ã€‚å‹¸é›™æ–¹å§»ç·£å‰å®šï¼Œæ‡‰ä»¥å’Œç‚ºè²´ã€‚", audio: "https://sutian.moe.edu.tw/media/senn/mp3/imtong/s4/HC/270931.mp3" }
        ];

        const game = {
            settings: { mode: 'hanji', count: 5 },
            queue: [],
            currentIndex: 0,
            audioElement: document.getElementById('question-audio'),
            recognition: null,
            isRecording: false,
            bestTranscript: "", 
            recognitionTimeout: null,

            init: function() {
                this.setupMenu();
                this.setupSpeechRecognition();
            },

            setupMenu: function() {
                document.getElementById('mode-select').addEventListener('click', (e) => {
                    if(e.target.tagName === 'BUTTON') {
                        document.querySelectorAll('#mode-select .btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.settings.mode = e.target.dataset.mode;
                    }
                });

                document.getElementById('count-select').addEventListener('click', (e) => {
                    if(e.target.tagName === 'BUTTON') {
                        document.querySelectorAll('#count-select .btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.settings.count = e.target.dataset.count;
                    }
                });
            },

            setupSpeechRecognition: function() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = true;
                    this.recognition.lang = 'cmn-Hant-TW'; 
                    
                    this.recognition.onresult = (event) => {
                        let interim = '';
                        let final = '';
                        for (let i = event.resultIndex; i < event.results.length; ++i) {
                            if (event.results[i].isFinal) {
                                final += event.results[i][0].transcript;
                            } else {
                                interim += event.results[i][0].transcript;
                            }
                        }
                        this.bestTranscript = final || interim || this.bestTranscript;
                    };

                    this.recognition.onspeechend = () => {
                        try { this.recognition.stop(); } catch(e) {}
                    };

                    this.recognition.onerror = (event) => {
                        if(this.recognitionTimeout) clearTimeout(this.recognitionTimeout);
                        if (event.error === 'no-speech') return; 

                        let msg = "éŒ„éŸ³å¤±æ•—";
                        if(event.error === 'not-allowed') msg = "è«‹å…è¨±æ¬Šé™";
                        if(event.error === 'network') msg = "ç¶²è·¯éŒ¯èª¤";

                        this.resetMicUI(msg);
                        this.isRecording = false;
                    };
                    
                    this.recognition.onend = () => {
                         this.isRecording = false;
                         document.getElementById('mic-btn').classList.remove('listening');
                         document.getElementById('spectrum-visual').style.display = 'none';
                         this.processAnalysis(this.bestTranscript);
                    };

                } else {
                    alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹ä½¿ç”¨ Google Chromeã€‚");
                }
            },

            shuffle: function(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            },

            start: function() {
                let pool = [...database];
                this.shuffle(pool);
                let count = this.settings.count === 'all' ? pool.length : parseInt(this.settings.count);
                
                this.queue = [];
                while(this.queue.length < count) {
                    let batch = [...pool];
                    this.shuffle(batch);
                    for(let item of batch) {
                        if(this.queue.length < count) this.queue.push(item);
                    }
                }

                this.currentIndex = 0;
                this.switchScreen('game');
                this.renderQuestion();
            },

            switchScreen: function(screenName) {
                document.getElementById('menu-screen').style.display = screenName === 'menu' ? 'flex' : 'none';
                document.getElementById('game-screen').style.display = screenName === 'game' ? 'flex' : 'none';
            },

            renderQuestion: function() {
                const item = this.queue[this.currentIndex];
                const displayText = document.getElementById('display-text');
                const defText = document.getElementById('definition-text');
                const progressText = document.getElementById('progress-text');
                const resultBox = document.getElementById('result-feedback');
                
                resultBox.style.display = 'none';
                resultBox.classList.remove('show');
                document.getElementById('answer-text').style.display = 'none';
                document.getElementById('next-btn').disabled = true;
                document.getElementById('next-btn').style.backgroundColor = '';
                document.getElementById('next-btn').style.color = '';
                document.getElementById('mic-status').innerText = "é»æ“ŠéŒ„éŸ³ (5ç§’)";
                document.getElementById('spectrum-visual').style.display = 'none';

                displayText.innerHTML = this.settings.mode === 'hanji' ? item.hanji : item.lomaji;
                
                const len = displayText.innerHTML.length;
                if(window.innerWidth < 480) {
                    if(len > 12) displayText.style.fontSize = '1.4rem';
                    else if(len > 8) displayText.style.fontSize = '1.6rem';
                    else displayText.style.fontSize = '2rem';
                } else {
                    if(len > 15) displayText.style.fontSize = '1.3rem';
                    else if(len > 8) displayText.style.fontSize = '1.8rem';
                    else displayText.style.fontSize = '2.2rem';
                }

                defText.innerText = item.mean;
                progressText.innerText = `åºè™Ÿ ${this.currentIndex + 1} / ${this.queue.length}`;

                this.audioElement.src = item.audio;
                this.audioElement.load(); 
            },

            playAudio: function() {
                this.audioElement.play();
            },

            recordVoice: function() {
                if(this.isRecording) return;
                if(!this.recognition) return;

                document.getElementById('result-feedback').style.display = 'none';
                document.getElementById('answer-text').style.display = 'none';

                this.isRecording = true;
                this.bestTranscript = ""; 
                
                const btn = document.getElementById('mic-btn');
                const status = document.getElementById('mic-status');
                const spectrum = document.getElementById('spectrum-visual');
                
                btn.classList.add('listening');
                status.innerText = "è†è½ä¸­...";
                spectrum.style.display = 'flex'; 
                
                try {
                    this.recognition.start();
                } catch(e) { console.log("Started"); }

                this.recognitionTimeout = setTimeout(() => {
                    if(this.isRecording) {
                        try { this.recognition.stop(); } catch(e) {}
                    }
                }, 5000);
            },

            processAnalysis: function(transcript) {
                if(this.recognitionTimeout) clearTimeout(this.recognitionTimeout);

                const btn = document.getElementById('mic-btn');
                const status = document.getElementById('mic-status');
                const spectrum = document.getElementById('spectrum-visual');
                
                btn.classList.remove('listening');
                btn.classList.add('processing');
                status.innerText = "æ¯”å°ä¸­...";
                spectrum.style.display = 'none'; 

                setTimeout(() => {
                    btn.classList.remove('processing');
                    status.innerText = "å®Œæˆ";
                    this.checkAnswer(transcript);
                }, 500);
            },

            calculateSimilarity: function(s1, s2) {
                if (s1.length === 0) return s2.length === 0 ? 1.0 : 0.0;
                if (s2.length === 0) return 0.0;

                const len1 = s1.length;
                const len2 = s2.length;
                const matrix = [];

                for (let i = 0; i <= len1; i++) { matrix[i] = [i]; }
                for (let j = 0; j <= len2; j++) { matrix[0][j] = j; }

                for (let i = 1; i <= len1; i++) {
                    for (let j = 1; j <= len2; j++) {
                        const cost = s1[i - 1] === s2[j - 1] ? 0 : 1;
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j] + 1,       
                            matrix[i][j - 1] + 1,       
                            matrix[i - 1][j - 1] + cost 
                        );
                    }
                }

                const distance = matrix[len1][len2];
                const maxLength = Math.max(len1, len2);
                return 1.0 - (distance / maxLength);
            },

            checkAnswer: function(transcript) {
                const currentItem = this.queue[this.currentIndex];
                const targetText = this.settings.mode === 'hanji' ? currentItem.hanji : currentItem.lomaji;
                
                // æ¸…ç†è¼¸å…¥æ–‡å­— (ç§»é™¤æ¨™é», ç©ºç™½, è½‰å°å¯«)
                const cleanInput = transcript.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()ã€‚ï¼Œã€ï¼Ÿ ]/g,"").toLowerCase();
                const cleanTarget = targetText.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()ã€‚ï¼Œã€ï¼Ÿ ]/g,"").toLowerCase();

                // è¨ˆç®—ç›¸ä¼¼åº¦
                const similarityScore = this.calculateSimilarity(cleanInput, cleanTarget);
                console.log(`Score: ${similarityScore.toFixed(2)} (In: ${cleanInput} | Tgt: ${cleanTarget})`);

                let status = 'wrong';

                // ä¸‰æ®µå¼åˆ¤å®š (60% / 20%)
                if (similarityScore >= 0.6) {
                    status = 'correct';
                } else if (similarityScore >= 0.2) {
                    status = 'partial';
                } else {
                    status = 'wrong';
                }

                // å¼·åˆ¶å¾Œé–€
                if(transcript.includes("æ¸¬è©¦æ­£ç¢º")) status = 'correct';

                this.showResult(status, targetText, transcript);
            },

            resetMicUI: function(msg) {
                const btn = document.getElementById('mic-btn');
                const status = document.getElementById('mic-status');
                const spectrum = document.getElementById('spectrum-visual');
                btn.classList.remove('listening');
                btn.classList.remove('processing');
                spectrum.style.display = 'none';
                status.innerText = msg;
            },

            showResult: function(status, targetText, transcript) {
                const resultBox = document.getElementById('result-feedback');
                const answerTextDiv = document.getElementById('answer-text');
                const nextBtn = document.getElementById('next-btn');

                resultBox.style.display = 'flex';
                void resultBox.offsetWidth;
                resultBox.classList.add('show');
                
                answerTextDiv.style.display = 'block';
                resultBox.className = 'result-box show';

                let displayHTML = "";

                // æª¢æŸ¥ä½¿ç”¨è€…çš„èªéŸ³è¼¸å…¥ (transcript) æ˜¯å¦åŒ…å«ç›®æ¨™å­—å…ƒï¼Œç”¨æ–¼è®Šè‰²é‚è¼¯
                const cleanTranscript = transcript.toLowerCase();

                if (status === 'correct') {
                    resultBox.classList.add('result-correct');
                    resultBox.innerHTML = "æ­£ç¢ºï¼å…±ä½ æ‹å™—ä»”ï¼";
                    displayHTML = `<span class="char-correct">${targetText}</span>`;
                } else if (status === 'partial') {
                    resultBox.classList.add('result-partial');
                    resultBox.innerHTML = "éƒ¨ä»½æ¯‹è‘—ï¼Œé–£ä¸€æ”¹ï¼";
                    
                    // æ™ºæ…§è®Šè‰²ï¼šæª¢æŸ¥æ¯å€‹å­—æ˜¯å¦å‡ºç¾åœ¨è¾¨è­˜çµæœä¸­
                    for(let char of targetText) {
                        // å¿½ç•¥æ¨™é»ç¬¦è™Ÿå’Œç©ºæ ¼çš„æ¯”å°
                        if (/[.,\/#!$%\^&\*;:{}=\-_`~()ã€‚ï¼Œã€ï¼Ÿ ]/.test(char)) {
                            displayHTML += `<span>${char}</span>`;
                        } else if (cleanTranscript.includes(char.toLowerCase())) {
                            displayHTML += `<span class="char-correct">${char}</span>`;
                        } else {
                            displayHTML += `<span class="char-wrong">${char}</span>`;
                        }
                    }
                } else {
                    resultBox.classList.add('result-wrong');
                    resultBox.innerHTML = "æ¯‹è‘—ï¼ä½ é–£è©¦ä¸€æ“ºï¼";
                    displayHTML = `<span class="char-wrong">${targetText}</span>`;
                }

                answerTextDiv.innerHTML = displayHTML;

                nextBtn.disabled = false;
                nextBtn.style.backgroundColor = 'var(--duo-green)';
                nextBtn.style.color = 'white';
                nextBtn.style.borderBottom = '4px solid var(--duo-green-shadow)';
            },

            nextQuestion: function() {
                if(this.currentIndex < this.queue.length - 1) {
                    this.currentIndex++;
                    this.renderQuestion();
                } else {
                    alert("æ¸¬é©—çµæŸï¼è¿”å›ä¸»é¸å–®ã€‚");
                    this.backToMenu();
                }
            },

            goBack: function() {
                if(confirm("æŒ‰é‡æ´—å°‡æœƒé‡æ–°æ´—ç‰Œä¸¦é‡æ–°é–‹å§‹ï¼Œç¢ºå®šå—ï¼Ÿ")) {
                    this.start();
                }
            },

            backToMenu: function() {
                this.switchScreen('menu');
            }
        };

        game.init();
    </script>
</body>
</html>
